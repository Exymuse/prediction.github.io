
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <title>
    Map
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="assets/css/soft-ui-dashboard.css?v=1.0.3" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/test/soft-ui-dashboard-pro/assets/css/soft-ui-dashboard.min.css?v=1.0.0" rel="stylesheet">

  <!-- Leaflet Files -->
  <link rel="stylesheet" href="assets/css/leaflet.css" />
  <script src="assets/js/plugins/leaflet.js"></script>


  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.1.4/dist/esri-leaflet.js" integrity="sha512-m+BZ3OSlzGdYLqUBZt3u6eA0sH+Txdmq7cqA1u8/B2aTXviGMMLOfrKyiIW7181jbzZAY0u+3jWoiL61iLcTKQ==" crossorigin=""></script>


  <!-- Load Esri Leaflet Geocoder from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.9/dist/esri-leaflet-geocoder.css" integrity="sha512-v5YmWLm8KqAAmg5808pETiccEohtt8rPVMGQ1jA6jqkWVydV5Cuz3nJ9fQ7ittSxvuqsvI9RSGfVoKPaAJZ/AQ==" crossorigin="">
  <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.9/dist/esri-leaflet-geocoder.js" integrity="sha512-QXchymy6PyEfYFQeOUuoz5pH5q9ng0eewZN8Sv0wvxq3ZhujTGF4eS/ySpnl6YfTQRWmA2Nn3Bezi9xuF8yNiw==" crossorigin=""></script>

  <script src="assets/js/plugins/jquery.js"></script>
  <script src="assets/js/nav-control.js"></script>
</head>

<body class="g-sidenav-show  bg-gray-100">
 <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 nav-left" id="sidenav-main">
 </aside>

 <main class="main-content position-relative max-height-vh-100 h-100 mt-1 border-radius-lg ">
  <!-- Navbar -->
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl nav-top" id="navbarBlur" navbar-scroll="true">
  </nav>
  <!-- End Navbar -->
  <div class="container-fluid py-4">
    <div class="row mtd-4">
      <div class="col-12">
        <div class="card">

          <div class="card-header pb-0 p-3">
           <div class="row">
            <div class="col-6 align-items-center">
              <h6 class="mb-0">Coffee Production Geolocation</h6>
              <p class="text-sm mb-0">Select year to show geolocation data of coffee production</p>
            </div>
          </div>
        </div>
        <div class="card-body px-3 pt-0 pb-2">
         <div class="row">
          <div class="col pt-2">
            <select class="form-control" name="choices-button" id="choices-button" placeholder="Departure">

            </select>
          </div>
        </div>


        <style type="text/css">
          #map { height: 50vh; }

          .choices__list--dropdown.is-active{
            z-index: 9999;
          }
        </style>




      </div>

      <div class="card-body px-3 pt-0 pb-2">
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="card">

      <div class="card-body px-3 pt-2 pb-2">

        <div class="row pt-2">
          <div class="col">
            <div id="map"></div>
          </div>
        </div>
        
        <style type="text/css">
          #map { height: 80vh; }
        </style>




      </div>

      <div class="card-body px-3 pt-0 pb-2">
      </div>
    </div>
  </div>
</div>



<footer class="footer pt-3  ">
  <div class="container-fluid">
    <div class="row align-items-center justify-content-lg-between">
      <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="copyright text-center text-sm text-muted text-lg-start">
          Â© <script>
            document.write(new Date().getFullYear())
          </script>,
          made with <i class="fa fa-heart"></i> by
          <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Creative Tim</a>
          for a better web.
        </div>
      </div>
      <div class="col-lg-6">
        <ul class="nav nav-footer justify-content-center justify-content-lg-end">
          <li class="nav-item">
            <a href="https://www.creative-tim.com" class="nav-link text-muted" target="_blank">Creative Tim</a>
          </li>
          <li class="nav-item">
            <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted" target="_blank">About Us</a>
          </li>
          <li class="nav-item">
            <a href="https://creative-tim.com/blog" class="nav-link text-muted" target="_blank">Blog</a>
          </li>
          <li class="nav-item">
            <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted" target="_blank">License</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>
</div>
</main>

<!--   Core JS Files   -->

<script src="assets/js/core/popper.min.js"></script>
<script src="assets/js/core/bootstrap.min.js"></script>
<script src="assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="assets/js/plugins/smooth-scrollbar.min.js"></script>
<script src="assets/js/plugins/choices.min.js"></script>



<script type="text/javascript">
    // Create the map
    var map = L.map('map').setView([-0.989818181999965, 113.91586500000005], 6);
    // Set up the OSM layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var locations = [];
    var group = L.layerGroup().addTo(map);
    

    $('#choices-button').change(function(){

      getGeoData();


    })



    function getGeoData(){
      map.removeLayer(group);
      var year = $('#choices-button').val();

      $.ajax({
        type: 'POST',
        url: 'get_map.php',
        data: {year: year},
        dataType: 'json',
        cache: false,
        beforeSend: function(){
          locations = [];
          group = L.layerGroup().addTo(map);
        },
        success: function(result){ /* GET THE TO BE RETURNED DATA */
          // console.log(result);
          $(result).each(function() {
            locations.push([this.province,parseFloat(this.lat),parseFloat(this.lng),this.production,this.forecast,this.forecast_next,this.growth,this.gstat]);

          });


          console.log(locations);
          // map.removeLayer(marker);
          for (var i = 0; i < locations.length; i++) {

            if (locations[i][7]==null) {
              var growth = "fa fa-square";
              var txtcolor = "text-secondary";
            }else if (locations[i][7]==1) {
              var growth = "fa fa-arrow-up";
              var txtcolor = "text-success";
            }else if (locations[i][7]==0){
              var growth = "fa fa-arrow-down";
              var txtcolor = "text-danger";
            }

            var popup = L.popup();
            marker = L.marker([locations[i][1], locations[i][2]])
            .bindPopup(locations[i][0]+'<br>Production : '+locations[i][3]+' Ton<hr>Forecast : '+locations[i][4]+' Ton<br>Next Year Forecast : '+locations[i][5]+' Ton<hr><i class="'+growth+" "+txtcolor+'" aria-hidden="true"></i> <span class="font-weight-bolder '+txtcolor+'">'+locations[i][6]+'%</span><span class="font-weight-bolder"> Compare to previous year</span>');
            group.addLayer(marker);
            marker.openPopup();
          }
        }
      });
    }




    var searchControl = L.esri.Geocoding.geosearch().addTo(map);

  </script>

  <script type="text/javascript">
    var currentYear = (new Date).getFullYear();
    $.get("get_year.php", function(data, status){
      var response = $.parseJSON(data);
      console.log(response);
      var html = '';
      $(response).each(function() {
        if (this.year == currentYear) {
          html = html + '<option value="'+this.year+'" selected="">'+this.year+' - Total Coffee Production '+this.production+' Ton</option>';
        }else{
         html = html + '<option value="'+this.year+'">'+this.year+' - Total Coffee Production '+this.production+' Ton</option>';
       }

     });

      $('#choices-button').append(html);
      if (document.getElementById('choices-button')) {
        getGeoData();
        var element = document.getElementById('choices-button');
        const example = new Choices(element, {
          searchEnabled: false
        });
      }

    });



  </script>
</body>

</html>